<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Download - Beautiful Interface</title>
    <link rel="icon" href="images/apache_orc_logo_icon_167862.png" type="image/x-icon">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root{
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --card-glass: rgba(255, 255, 255, 0.03);
            --card-border: rgba(0, 0, 0, 0.08);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background-image: url('images/234.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            z-index: 0;
        }
        
        .card {
            width: 100%;
            max-width: 1200px;
            background: #ffffff;
            border-radius: 28px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            animation: cardEntrance 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        .header-text h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }
        
        .header-text p {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        
        .close-btn {
            margin-left: auto;
            width: 44px;
            height: 44px;
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: var(--accent-red);
            text-decoration: none;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .close-btn:hover {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .input-wrapper input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .input-wrapper input::placeholder {
            color: var(--text-muted);
        }
        
        .input-wrapper input:focus {
            background: #ffffff;
            border-color: #6366f1;
            box-shadow: 
                0 0 0 4px rgba(99, 102, 241, 0.1),
                0 4px 12px rgba(99, 102, 241, 0.15);
        }
        
        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(239, 68, 68, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            color: var(--accent-red);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .clear-btn:hover {
            background: var(--accent-red);
            color: white;
            transform: translateY(-50%) rotate(90deg);
        }
        
        .btn {
            padding: 16px 28px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 50%, #4338ca 100%);
            color: white;
            box-shadow: 
                0 10px 25px rgba(99, 102, 241, 0.3),
                0 4px 12px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 15px 35px rgba(99, 102, 241, 0.4),
                0 8px 20px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 
                0 8px 20px rgba(99, 102, 241, 0.3),
                0 4px 12px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .content {
            display: grid;
            gap: 24px;
            transition: all 0.4s ease;
        }
        
        .content.has-preview {
            grid-template-columns: 1fr 400px;
        }
        
        .preview-container {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            height: 480px;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
            display: none;
            opacity: 0;
            transform: scale(0.95);
        }
        
        .preview-container.show {
            display: flex;
            animation: previewFadeIn 0.5s ease forwards;
        }
        
        @keyframes previewFadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .preview-container.active {
            border-color: #6366f1;
            box-shadow: 
                0 0 40px rgba(99, 102, 241, 0.2),
                0 10px 30px rgba(99, 102, 241, 0.15);
        }
        
        .placeholder {
            text-align: center;
            color: #94a3b8;
            font-size: 16px;
            font-weight: 600;
            padding: 40px;
        }
        
        .placeholder::before {
            content: 'üé¨';
            display: block;
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.6;
            animation: placeholderPulse 2s ease-in-out infinite;
        }
        
        @keyframes placeholderPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }
        
        .preview-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease;
        }
        
        .preview-container.loaded iframe {
            display: block;
            opacity: 1;
        }
        
        .preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            backdrop-filter: blur(8px);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .preview-container.loaded .preview-overlay {
            transform: translateY(0);
        }
        
        .preview-overlay h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }
        
        .preview-overlay p {
            color: #cbd5e1;
            font-size: 14px;
        }
        
        .sidebar {
            display: none;
            flex-direction: column;
            gap: 16px;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .sidebar.visible {
            display: flex;
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-color: #cbd5e1;
            transform: translateY(-4px);
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.08),
                0 4px 12px rgba(0, 0, 0, 0.06);
        }
        
        .video-id-label {
            color: var(--text-muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .video-id-value {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            word-break: break-all;
            animation: idPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #fileInfo {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes idPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .btn-download {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            color: white;
            box-shadow: 
                0 10px 25px rgba(16, 185, 129, 0.3),
                0 4px 12px rgba(16, 185, 129, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .btn-download:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-download:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 
                0 15px 35px rgba(16, 185, 129, 0.4),
                0 8px 20px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn-download:not(:disabled):active {
            transform: translateY(0px);
            box-shadow: 
                0 8px 20px rgba(16, 185, 129, 0.3),
                0 4px 12px rgba(16, 185, 129, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .quality-selector {
            margin-top: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            border-radius: 12px;
            border: 2px solid rgba(99, 102, 241, 0.15);
        }

        .quality-selector label {
            display: block;
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quality-selector select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .quality-selector select:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .quality-selector select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: white;
        }
        
        @media (max-width: 1024px) {
            .content.has-preview {
                grid-template-columns: 1fr;
            }
            
            .preview-container.show {
                height: 360px;
            }
        }
        
        @media (max-width: 640px) {
            .card {
                padding: 24px;
            }
            
            .header {
                flex-wrap: wrap;
            }
            
            .close-btn {
                margin-left: 0;
                order: -1;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .preview-container.show {
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <div class="logo">üì∫</div>
            <div class="header-text">
                <h1>YouTube Video Download</h1>
                <p>T·∫£i video t·ª´ Youtube th√†nh file mp3, mp4, video v·ªÅ m√°y</p>
            </div>
            <a href="Home.html" class="close-btn" title="ƒê√≥ng">‚úï</a>
        </div>

        <div class="controls">
            <div class="input-wrapper">
                <input 
                    id="urlInput" 
                    type="text"
                    placeholder="D√°n link YouTube v√†o ƒë√¢y (v√≠ d·ª•: https://youtu.be/abc123)"
                    autocomplete="off"
                />
                <button class="clear-btn" id="clearBtn" title="X√≥a">‚úï</button>
            </div>
            <button class="btn btn-primary" id="previewBtn">
                <span>üîé</span>
                <span class="label">Xem tr∆∞·ªõc</span>
            </button>
        </div>

        <div class="content">
            <div class="preview-container" id="previewArea">
                <div class="placeholder">
                    D√°n link YouTube v√† nh·∫•n "Xem tr∆∞·ªõc" ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </div>
                <iframe 
                    id="videoPreview" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen
                ></iframe>
                <div class="preview-overlay">
                    <h3 id="overlayTitle">‚Äî</h3>
                    <p id="overlayInfo">‚Äî</p>
                </div>
            </div>

            <aside class="sidebar" id="sidebar">
                <div class="info-card">
                    <div class="video-id-label">Video ID</div>
                    <div class="video-id-value" id="videoId">‚Äî</div>
                    <div id="fileInfo"></div>
                </div>
                <button class="btn btn-download" id="downloadBtn">
                    <span>‚¨áÔ∏è</span>
                    <span class="label">T·∫£i xu·ªëng</span>
                </button>
            </aside>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const previewBtn = document.getElementById('previewBtn');
        const clearBtn = document.getElementById('clearBtn');
        const previewArea = document.getElementById('previewArea');
        const iframe = document.getElementById('videoPreview');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayInfo = document.getElementById('overlayInfo');
        const videoIdEl = document.getElementById('videoId');
        const downloadBtn = document.getElementById('downloadBtn');
        const sidebar = document.getElementById('sidebar');
        const content = document.querySelector('.content');
        
        let downloadData = null;
        let isPreparingDownload = false;
        let selectedQuality = null;

        function getVideoId(url) {
            if (!url) return null;
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,
                /youtube\.com\/embed\/([^&\n?#]+)/,
                /youtube\.com\/v\/([^&\n?#]+)/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const mb = bytes / (1024 * 1024);
            if (mb >= 1000) {
                return (mb / 1024).toFixed(2) + ' GB';
            }
            return mb.toFixed(2) + ' MB';
        }

        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function prepareDownload(id) {
            isPreparingDownload = true;
            downloadData = null;
            
            const btnLabel = downloadBtn.querySelector('.label');
            const originalText = btnLabel.textContent;
            btnLabel.textContent = 'ƒêang t·∫£i th√¥ng tin...';
            downloadBtn.disabled = true;
            
            try {
                const response = await fetch(
                    `https://youtube-media-downloader.p.rapidapi.com/v2/video/details?videoId=${id}&urlAccess=normal&videos=auto&audios=auto`,
                    {
                        method: 'GET',
                        headers: {
                            'x-rapidapi-host': 'youtube-media-downloader.p.rapidapi.com',
                            'x-rapidapi-key': '73633ff8ebmsh1fdac1697990ffbp1c6989jsnda9fe7b1cee4'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin video');
                }
                
                downloadData = await response.json();
                console.log('Video data:', downloadData);
                console.log('Videos items:', downloadData.videos?.items);
                console.log('Videos items length:', downloadData.videos?.items?.length);
                console.log('Audios items:', downloadData.audios?.items);
                isPreparingDownload = false;
                
                const fileInfoEl = document.getElementById('fileInfo');
                if (fileInfoEl && downloadData) {
                    let infoHTML = '';
                    
                    // Hi·ªÉn th·ªã th√¥ng tin video
                    if (downloadData.title) {
                        overlayTitle.textContent = downloadData.title;
                    }
                    
                    if (downloadData.duration) {
                        overlayInfo.textContent = `Th·ªùi l∆∞·ª£ng: ${formatDuration(downloadData.duration)}`;
                    }
                    
                    console.log('Rendering quality selector...');
                    console.log('Has video items:', downloadData.videos?.items?.length > 0);
                    console.log('Has audio items:', downloadData.audios?.items?.length > 0);
                    
                    // T·∫°o dropdown ch·ªçn ch·∫•t l∆∞·ª£ng t·ª´ videos.items
                    if (downloadData.videos?.items && downloadData.videos.items.length > 0) {
                        const videoItems = downloadData.videos.items;
                        console.log('Creating quality selector with', videoItems.length, 'video items');
                        
                        // L·ªçc v√† s·∫Øp x·∫øp theo quality (cao xu·ªëng th·∫•p)
                        const qualityOrder = ['2160p', '1440p', '1080p', '720p', '480p', '360p', '240p', '144p'];
                        
                        // L·ªçc nh·ªØng video c√≥ audio ho·∫∑c ch·∫•t l∆∞·ª£ng cao
                        const filteredVideos = videoItems.filter(item => {
                            // ∆Øu ti√™n video c√≥ audio ho·∫∑c ch·∫•t l∆∞·ª£ng t·ª´ 360p tr·ªü l√™n
                            return item.hasAudio === true || 
                                   (item.quality && ['2160p', '1440p', '1080p', '720p', '480p', '360p'].some(q => item.quality.includes(q)));
                        });
                        
                        const sortedItems = [...filteredVideos].sort((a, b) => {
                            const aIndex = qualityOrder.findIndex(q => a.quality?.includes(q));
                            const bIndex = qualityOrder.findIndex(q => b.quality?.includes(q));
                            if (aIndex === -1 && bIndex === -1) return 0;
                            if (aIndex === -1) return 1;
                            if (bIndex === -1) return -1;
                            return aIndex - bIndex;
                        });
                        
                        console.log('Sorted items:', sortedItems.length);
                        
                        if (sortedItems.length > 0) {
                            infoHTML += '<div class="quality-selector">';
                            infoHTML += '<label>üìπ Ch·ªçn ch·∫•t l∆∞·ª£ng video:</label>';
                            infoHTML += '<select id="qualitySelect">';
                            
                            sortedItems.forEach((item, index) => {
                                const quality = item.quality || 'Unknown';
                                const size = item.sizeText || 'N/A';
                                const extension = item.extension || 'mp4';
                                const originalIndex = videoItems.indexOf(item);
                                const audioTag = item.hasAudio ? ' üîä' : '';
                                
                                // Highlight quality ph·ªï bi·∫øn
                                let badge = '';
                                if (quality.includes('1080p')) badge = ' üî• HD';
                                else if (quality.includes('720p')) badge = ' ‚≠ê HD';
                                else if (quality.includes('2160p') || quality.includes('4K')) badge = ' üíé 4K';
                                
                                infoHTML += `<option value="${originalIndex}">${quality}${badge}${audioTag} ‚Ä¢ ${size} ‚Ä¢ ${extension.toUpperCase()}</option>`;
                            });
                            
                            infoHTML += '</select>';
                            infoHTML += '</div>';
                            
                            // M·∫∑c ƒë·ªãnh ch·ªçn video ch·∫•t l∆∞·ª£ng cao nh·∫•t
                            selectedQuality = videoItems.indexOf(sortedItems[0]);
                            
                            // Hi·ªÉn th·ªã th√¥ng tin video ƒë∆∞·ª£c ch·ªçn
                            const selectedItem = sortedItems[0];
                            infoHTML += `
                                <div style="margin-top: 12px; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.1);">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">‚úÖ ƒê√£ ch·ªçn:</div>
                                    <div id="selectedQualityInfo" style="font-size: 14px; font-weight: 600; color: #10b981;">${selectedItem.quality} ‚Ä¢ ${selectedItem.sizeText}</div>
                                </div>
                            `;
                        } else {
                            infoHTML += `
                                <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.1);">
                                    <div style="font-size: 13px; color: #ef4444; font-weight: 600;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y video ph√π h·ª£p</div>
                                </div>
                            `;
                        }
                    } else if (downloadData.audios?.items && downloadData.audios.items.length > 0) {
                        console.log('Creating audio quality selector with', downloadData.audios.items.length, 'audio items');
                        
                        const audioItems = downloadData.audios.items;
                        infoHTML += '<div class="quality-selector">';
                        infoHTML += '<label>üéµ Ch·ªçn ch·∫•t l∆∞·ª£ng audio:</label>';
                        infoHTML += '<select id="qualitySelect">';
                        
                        audioItems.forEach((audio, index) => {
                            const quality = audio.mimeType || 'Unknown';
                            const size = audio.sizeText || 'N/A';
                            const extension = audio.extension || 'm4a';
                            infoHTML += `<option value="${index}">${extension.toUpperCase()} ‚Ä¢ ${size}</option>`;
                        });
                        
                        infoHTML += '</select>';
                        infoHTML += '</div>';
                        
                        selectedQuality = 0;
                    } else {
                        console.warn('No video or audio items available');
                        infoHTML += `
                            <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.1);">
                                <div style="font-size: 13px; color: #ef4444; font-weight: 600;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y link t·∫£i xu·ªëng</div>
                            </div>
                        `;
                    }
                    
                    // Hi·ªÉn th·ªã th√¥ng tin th√™m
                    if (downloadData.channelTitle) {
                        infoHTML += `
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251, 146, 60, 0.05); border-radius: 8px; border: 1px solid rgba(251, 146, 60, 0.1);">
                                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">K√™nh:</div>
                                <div style="font-size: 14px; font-weight: 600; color: #1e293b;">${downloadData.channelTitle}</div>
                            </div>
                        `;
                    }
                    
                    fileInfoEl.innerHTML = infoHTML;
                    console.log('HTML rendered, innerHTML length:', infoHTML.length);
                    
                    // Th√™m event listener cho dropdown v·ªõi setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render
                    setTimeout(() => {
                        const qualitySelect = document.getElementById('qualitySelect');
                        console.log('Quality select element:', qualitySelect);
                        
                        if (qualitySelect) {
                            qualitySelect.addEventListener('change', (e) => {
                                selectedQuality = parseInt(e.target.value);
                                console.log('Selected quality index:', selectedQuality);
                                
                                // C·∫≠p nh·∫≠t th√¥ng tin video ƒë∆∞·ª£c ch·ªçn
                                const selectedQualityInfo = document.getElementById('selectedQualityInfo');
                                if (selectedQualityInfo && downloadData.videos?.items) {
                                    const item = downloadData.videos.items[selectedQuality];
                                    if (item) {
                                        selectedQualityInfo.textContent = `${item.quality} ‚Ä¢ ${item.sizeText}`;
                                    }
                                }
                            });
                            console.log('Event listener attached to quality select');
                        } else {
                            console.error('Quality select element not found!');
                        }
                    }, 100);
                }
                
                downloadBtn.disabled = false;
                btnLabel.textContent = 'T·∫£i xu·ªëng';
                
            } catch (error) {
                console.error('L·ªói t·∫£i th√¥ng tin:', error);
                isPreparingDownload = false;
                downloadBtn.disabled = false;
                btnLabel.textContent = originalText;
                alert('L·ªói khi t·∫£i th√¥ng tin video. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        
        function showPreview(id) {
            content.classList.add('has-preview');
            previewArea.classList.add('show');
            sidebar.classList.add('visible');
            
            iframe.src = `https://www.youtube.com/embed/${id}`;
            
            previewArea.classList.remove('loaded');
            
            iframe.onload = () => {
                previewArea.classList.add('loaded', 'active');
                
                const placeholder = previewArea.querySelector('.placeholder');
                if (placeholder) placeholder.remove();
            };
            
            videoIdEl.textContent = id;
            videoIdEl.style.animation = 'none';
            setTimeout(() => {
                videoIdEl.style.animation = '';
            }, 10);
            
            downloadBtn.disabled = true;
            prepareDownload(id);
        }

        previewBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            const id = getVideoId(url);
            
            if (!id) {
                urlInput.style.borderColor = 'var(--accent-red)';
                setTimeout(() => {
                    urlInput.style.borderColor = '';
                }, 2000);
                return;
            }
            
            showPreview(id);
        });

        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') previewBtn.click();
        });

        clearBtn.addEventListener('click', () => {
            urlInput.value = '';
            urlInput.focus();
            
            iframe.src = '';
            content.classList.remove('has-preview');
            previewArea.classList.remove('loaded', 'active', 'show');
            sidebar.classList.remove('visible');
            
            overlayTitle.textContent = '‚Äî';
            overlayInfo.textContent = '‚Äî';
            videoIdEl.textContent = '‚Äî';
            
            const fileInfoEl = document.getElementById('fileInfo');
            if (fileInfoEl) fileInfoEl.innerHTML = '';
            
            downloadData = null;
            isPreparingDownload = false;
            selectedQuality = null;
            downloadBtn.disabled = false;
            const btnLabel = downloadBtn.querySelector('.label');
            if (btnLabel) btnLabel.textContent = 'T·∫£i xu·ªëng';
            
            let placeholder = previewArea.querySelector('.placeholder');
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = 'D√°n link YouTube v√† nh·∫•n "Xem tr∆∞·ªõc" ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                previewArea.insertBefore(placeholder, iframe);
            }
        });

        downloadBtn.addEventListener('click', async () => {
            const id = videoIdEl.textContent;
            if (id === '‚Äî') {
                alert('Vui l√≤ng xem tr∆∞·ªõc video tr∆∞·ªõc khi t·∫£i xu·ªëng.');
                return;
            }
            
            if (isPreparingDownload) {
                alert('ƒêang t·∫£i th√¥ng tin, vui l√≤ng ƒë·ª£i...');
                return;
            }
            
            // Ki·ªÉm tra c√≥ videos.items ho·∫∑c audios.items
            const hasVideos = downloadData?.videos?.items && downloadData.videos.items.length > 0;
            const hasAudios = downloadData?.audios?.items && downloadData.audios.items.length > 0;
            
            if (!hasVideos && !hasAudios) {
                alert('Kh√¥ng t√¨m th·∫•y link t·∫£i xu·ªëng. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            
            try {
                const btnLabel = downloadBtn.querySelector('.label');
                const originalText = btnLabel.textContent;
                
                // L·∫•y item ƒë∆∞·ª£c ch·ªçn
                let selectedItem = null;
                let fileName = downloadData.title || id;
                
                if (hasVideos) {
                    const itemIndex = selectedQuality !== null ? selectedQuality : 0;
                    selectedItem = downloadData.videos.items[itemIndex];
                    fileName += `_${selectedItem.quality}.${selectedItem.extension || 'mp4'}`;
                } else if (hasAudios) {
                    const itemIndex = selectedQuality !== null ? selectedQuality : 0;
                    selectedItem = downloadData.audios.items[itemIndex];
                    fileName += `.${selectedItem.extension || 'm4a'}`;
                }
                
                if (!selectedItem || !selectedItem.url) {
                    alert('Link t·∫£i xu·ªëng kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ ch·ªçn ch·∫•t l∆∞·ª£ng kh√°c.');
                    return;
                }
                
                console.log('Downloading:', selectedItem);
                console.log('Download URL:', selectedItem.url);
                console.log('Quality:', selectedItem.quality);
                console.log('Size:', selectedItem.sizeText);
                
                btnLabel.textContent = 'ƒêang t·∫£i... 0%';
                downloadBtn.disabled = true;
                
                // S·ª≠ d·ª•ng XMLHttpRequest ƒë·ªÉ t·∫£i file v·ªõi progress
                const xhr = new XMLHttpRequest();
                xhr.open('GET', selectedItem.url, true);
                xhr.responseType = 'blob';
                
                // Theo d√µi ti·∫øn tr√¨nh t·∫£i
                xhr.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        btnLabel.textContent = `ƒêang t·∫£i... ${percentComplete}%`;
                    }
                };
                
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        // T·∫°o blob URL t·ª´ response
                        const blob = xhr.response;
                        const blobUrl = URL.createObjectURL(blob);
                        
                        // T·∫°o link download
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = fileName;
                        a.style.display = 'none';
                        
                        document.body.appendChild(a);
                        a.click();
                        
                        // Cleanup
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(blobUrl);
                        }, 100);
                        
                        btnLabel.textContent = '‚úÖ ƒê√£ t·∫£i!';
                        
                        setTimeout(() => {
                            btnLabel.textContent = originalText;
                            downloadBtn.disabled = false;
                        }, 2000);
                    } else {
                        throw new Error(`HTTP ${xhr.status}`);
                    }
                };
                
                xhr.onerror = () => {
                    console.error('XHR error');
                    
                    // Fallback: M·ªü trong tab m·ªõi v·ªõi download attribute
                    btnLabel.textContent = 'ƒêang m·ªü...';
                    
                    const a = document.createElement('a');
                    a.href = selectedItem.url + '&title=' + encodeURIComponent(fileName);
                    a.download = fileName;
                    a.target = '_blank';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    setTimeout(() => {
                        btnLabel.textContent = originalText;
                        downloadBtn.disabled = false;
                        alert('N·∫øu video m·ªü trong tab m·ªõi, h√£y nh·∫•p chu·ªôt ph·∫£i v√†o video v√† ch·ªçn "Save video as..." ƒë·ªÉ t·∫£i v·ªÅ.');
                    }, 1000);
                };
                
                // B·∫Øt ƒë·∫ßu t·∫£i
                xhr.send();
                
            } catch (error) {
                console.error('L·ªói t·∫£i xu·ªëng:', error);
                const btnLabel = downloadBtn.querySelector('.label');
                btnLabel.textContent = 'T·∫£i xu·ªëng';
                downloadBtn.disabled = false;
                alert('C√≥ l·ªói x·∫£y ra khi t·∫£i xu·ªëng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        });
    </script>
</body>
</html>